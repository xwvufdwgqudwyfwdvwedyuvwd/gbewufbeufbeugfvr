--========================================================--
-- üîó MULTI WEBHOOK CONFIG (NO GUI) + PLAYER NAME SUPPORT
-- ‚úÖ Versi Perbaikan: Gambar 100% muncul dengan fallback CDN
--========================================================--

local WebhookConfigs = {
    {
        Url = "https://discord.com/api/webhooks/1434819185975758989/eW8i0rR9X7r4dn-s6vO0aCR4zZXlu8Ca4ClTK7FRsRYkKsDh4bbdsjVQiC-_f531OAqQ",
        Active = true,
        SelectedTiers = {"SECRET"}
    },
    {
        Url = "https://discord.com/api/webhooks/1434819559508021308/F1JGxJ3hQTc9z8PkZJiQHXJytPajq2CYncsQXD7QMMQKqOXiJy4uskbywpRFHGKO-vwm",
        Active = true,
        SelectedTiers = {"Mythic"}
    },
    {
}

--========================================================--
-- üîß FUNGSI UTAMA
--========================================================--

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

local Notification = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("Small Notification")
local Request = (syn and syn.request) or (http_request) or (fluxus and fluxus.request) or (krnl and request)

local TierMap = {
    [1] = "Common",
    [2] = "Uncommon",
    [3] = "Rare",
    [4] = "Epic",
    [5] = "Legendary",
    [6] = "Mythic",
    [7] = "SECRET"
}

local FishCounter = {
    Common = 0,
    Uncommon = 0,
    Rare = 0,
    Epic = 0,
    Legendary = 0,
    Mythic = 0,
    SECRET = 0
}

local function FormatNumber(num)
    num = tonumber(num) or 0
    if num >= 1e9 then
        return string.format("%.2fb", num / 1e9)
    elseif num >= 1e6 then
        return string.format("%.2fm", num / 1e6)
    elseif num >= 1e3 then
        return string.format("%.2fk", num / 1e3)
    else
        return tostring(num)
    end
end

local function FormatChance(chance)
    chance = tonumber(chance) or 0
    return string.format("%.2f%%", chance * 100)
end

-- ‚úÖ FIXED: Gambar fallback ke CDN Roblox
local function GetRobloxImage(assetId)
    if not assetId or assetId == "" then 
        return "https://i.imgur.com/zwCkN8P.png"
    end

    local fallback = "https://tr.rbxcdn.com/" .. assetId .. "-420x420.png"

    local success, response = pcall(function()
        return game:HttpGet("https://thumbnails.roblox.com/v1/assets?assetIds=" .. assetId .. "&size=420x420&format=Png&isCircular=false")
    end)

    if success and response then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(response)
        end)
        if ok and data and data.data and data.data[1] and data.data[1].imageUrl then
            return data.data[1].imageUrl
        end
    end

    return fallback
end

local function SendEmbed(url, data)
    if url ~= "" and Request then
        local payload = {["embeds"] = data.embeds}
        Request({
            Url = url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end
end

local function FindFishModule(fishName)
    local Items = ReplicatedStorage:WaitForChild("Items")
    for _, moduleScript in ipairs(Items:GetChildren()) do
        if moduleScript:IsA("ModuleScript") then
            local ok, data = pcall(require, moduleScript)
            if ok and data and data.Data and data.Data.Name then
                local realName = data.Data.Name
                if string.find(string.lower(fishName), string.lower(realName)) then
                    return data
                end
            end
        end
    end
    return nil
end

--========================================================--
-- ‚öôÔ∏è MAIN EVENT HANDLER
--========================================================--

local LastFishData = nil
local Container = Notification.Display.Container
local ItemName = Container:WaitForChild("ItemName")
local NewLabel = Notification.Display.NewFrame.Frame:WaitForChild("NewLabel")
local VectorFrame = Notification.Display.VectorFrame.Vector

ItemName:GetPropertyChangedSignal("Text"):Connect(function()
    local rawText = ItemName.Text
    if rawText == "" then return end

    local fishName, fishWeight = rawText:match("^(.-)%s*%((.-)%)$")
    fishName = (fishName and fishName:gsub("^%s+", ""):gsub("%s+$", "")) or rawText
    fishWeight = fishWeight or "Unknown"

    local fishData = FindFishModule(fishName)
    local tierNum = fishData and fishData.Data.Tier or 0
    local tierName = TierMap[tierNum] or "Unknown"
    local sellPrice = fishData and fishData.SellPrice or "Unknown"
    local chance = fishData and fishData.Probability and fishData.Probability.Chance or 0

    local newLabelText = NewLabel.Text or ""
    local RarityLabel = Container:WaitForChild("Rarity")
    local rarityText = RarityLabel.Text or "Unknown"

    local BagSizeLabel = Players.LocalPlayer.PlayerGui.Inventory.Main.Top.Options.Fish.Label:WaitForChild("BagSize")
    local bagSizeText = BagSizeLabel.Text or "Unknown"

    local assetId = string.match(VectorFrame.Image, "%d+")
    local imageUrl = GetRobloxImage(assetId)
    local playerName = LocalPlayer.Name

    local currentData = {
        Fish = fishName,
        Weight = fishWeight,
        Bag = bagSizeText,
        Rarity = rarityText
    }

    if LastFishData
        and LastFishData.Fish == currentData.Fish
        and LastFishData.Weight == currentData.Weight
        and LastFishData.Bag == currentData.Bag
        and LastFishData.Rarity == currentData.Rarity then
        return
    end
    LastFishData = currentData

    if FishCounter[tierName] ~= nil then
        FishCounter[tierName] = FishCounter[tierName] + 1
    end

    local counterFields = {}
    for _, name in ipairs({"Common","Uncommon","Rare","Epic","Legendary","Mythic","SECRET"}) do
        table.insert(counterFields, {
            ["name"] = "X :  " .. name .. " üé£",
            ["value"] = "```" .. tostring(FishCounter[name]) .. "```",
            ["inline"] = true
        })
    end

    local embed = {
        ["embeds"] = {{
            ["author"] = {["name"] = "Nexa Fishing Info"},
            ["title"] = "New Fish Caught!‚ùó",
            ["color"] = math.random(1000000, 16777215),
            ["fields"] = {
                {["name"] = "Player üë§", ["value"] = "```" .. playerName .. "```", ["inline"] = false},
                {["name"] = "Fish üêü", ["value"] = "```" .. fishName .. "```", ["inline"] = true},
                {["name"] = "KG ‚öñÔ∏è", ["value"] = "```" .. fishWeight .. "```", ["inline"] = true},
                {["name"] = "Tier ü•á", ["value"] = "```" .. tierName .. "```", ["inline"] = true},
                {["name"] = "Rarity üöÄ", ["value"] = "```" .. rarityText .. "```", ["inline"] = true},
                {["name"] = "Bag Size üíº", ["value"] = "```" .. bagSizeText .. "```", ["inline"] = true},
                {["name"] = "Sell Price ü™ô", ["value"] = "```" .. FormatNumber(sellPrice) .. "```", ["inline"] = true},
                {["name"] = "Chance üìà", ["value"] = "```" .. FormatChance(chance) .. "```", ["inline"] = true},
            },
            ["footer"] = {["text"] = "Nexa | Fishing Logger ‚Ä¢ Fish It! üêü"},
            ["timestamp"] = DateTime.now():ToIsoDate(),
            ["image"] = {["url"] = imageUrl or "https://i.imgur.com/zwCkN8P.png"}
        }}
    }

    for _, f in ipairs(counterFields) do
        table.insert(embed.embeds[1].fields, f)
    end

    if newLabelText ~= "" then
        table.insert(embed.embeds[1].fields, {["name"] = "Info", ["value"] = "```" .. newLabelText .. "```", ["inline"] = false})
    end

    -- üîÅ Kirim ke setiap Webhook yang aktif dan sesuai tier
    for _, cfg in ipairs(WebhookConfigs) do
        if cfg.Active and cfg.Url ~= "" then
            if #cfg.SelectedTiers == 0 or table.find(cfg.SelectedTiers, "All") or table.find(cfg.SelectedTiers, tierName) then
                SendEmbed(cfg.Url, embed)
            end
        end
    end
end)
